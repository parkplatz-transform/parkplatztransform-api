## Parkplatz Transform

Park Platz Transform API, intended to be consumed by the Park Platz Transform app, admin and potential 3rd parties.

### Relevant external documentation

| Name       | Documentation                                    | Role                |
| -----------| -------------------------------------------------|---------------------|
| FastAPI    | [docs](https://fastapi.tiangolo.com/)            | API Framework       |
| SQLAlchemy | [docs](https://docs.sqlalchemy.org/en/13/)       | ORM                 |
| Alembic    | [docs](https://alembic.sqlalchemy.org/en/latest/)| Database migrations |
| PostgresSQL| [docs](https://www.postgresql.org/)              | Database            |
| PostGIS    | [docs](https://postgis.net/documentation/)       | Geo Extensions      |

### Open API Documentation

Autogenerated API documentation can be found [here](https://parkplatztransform-api.herokuapp.com/docs) as well as
[redoc here](https://parkplatztransform-api.herkouapp.com/redoc)

### Authentication and Authorization

Authentication is done by generating a link and emailing it to a user. The user verifies they have access to the email address provided by clicking the link in the email.

Authorization is done once an email address is verified by an API endpoint. The verification endpoint will return a signed JWT, this can be provided in an `Authorization: Bearer XXX` header to make authorized requests.

See also: <br>
[Passwordless authentication](https://en.wikipedia.org/wiki/Passwordless_authentication)
<br/>
[Passwordless logins in Python](https://www.anthonycorletti.com/post/python-passwordless/)

### Local Development

If you would like to work on the backend, you can follow the steps bellow:

Clone the repository:
```shell
git clone git@github.com:theolampert/parkplatztransform-api.git && cd parkplatztransform-api
```

You will then need to create an `.env` file in the root directory of this project. It should look something like this:

```shell
SECRET_KEY=averysecretkey
DATABASE_URL=postgresql://postgres:postgres@postgres/postgres
# The following are optional and only required for testing email
MAILGUN_DOMAIN=<MAILGUN_DOMAIN>
MAILGUN_API_KEY=<MAILGUN_API_KEY> 
```

One way to run the API locally is by using docker and docker compose.

To build the containers and install dependencies:
```shell
docker-compose build
```

To start the database and python app:
```shell
docker-compose up
```

Now run the database migrations:
```shell
sh ./scripts/migrate.sh
```

The web server will be available [here](http://localhost:8023)

**Important**: Docker & docker compose configuration is not secure and optimised for local development, don't deploy the app using these settings.

If you prefer to run the app without using docker, make sure you have postgresql (with Postgis extension) running locally and set the appropriate value for the environment variable `DATABASE_URL`. You will need a Python 3.9+ and Pip installed.
Run `pip install -r requirements.txt` in the root directory to install dependencies.

### Deployment

The application is currently deployed on Heroku and depends on the following third-party services:
- Mailgun API for sending magic link emails
- Heroku Postgres with PostGIS extension installed

These services should set their environment variables automatically.

The application uses continuous integration and will automatically deploy the `main` branch on any commits.
